// ===========================================
// Modules Test Suite
// ===========================================
// Tests for the module system functionality
// Created: 2026-01-16

print("Starting Module System Tests...")
print("=" * 60)

let test_count = 0
let passed_count = 0
let failed_count = 0

// Helper function to track test results
function test_result(name, passed) {
    test_count = test_count + 1
    if passed {
        passed_count = passed_count + 1
        print("✓ " + name + " PASSED")
    } else {
        failed_count = failed_count + 1
        print("✗ " + name + " FAILED")
    }
}

// Test 1: Function Existence
print("\nTest 1: Verify Module Functions Exist")
print("-" * 60)

try {
    let has_load = typeof(load_module) == "function"
    let has_unload = typeof(unload_module) == "function"
    let has_reload = typeof(reload_module) == "function"
    let has_list = typeof(list_modules) == "function"
    let has_get = typeof(get_module) == "function"
    let has_exists = typeof(module_exists) == "function"
    let has_export = typeof(export) == "function"

    test_result("load_module exists", has_load)
    test_result("unload_module exists", has_unload)
    test_result("reload_module exists", has_reload)
    test_result("list_modules exists", has_list)
    test_result("get_module exists", has_get)
    test_result("module_exists exists", has_exists)
    test_result("export exists", has_export)
} catch error {
    print("✗ Error checking function existence: " + str(error))
}

// Test 2: List Modules (Initial State)
print("\nTest 2: List Modules (Initial State)")
print("-" * 60)

try {
    let modules = list_modules()

    test_result("list_modules returns array", typeof(modules) == "array")

    // Should be empty or have only built-in modules
    let is_array = typeof(modules) == "array"
    test_result("list_modules basic functionality", is_array)

    print("  Initial module count: " + str(length(modules)))
} catch error {
    test_result("List modules initial state", false)
    print("  Error: " + str(error))
}

// Test 3: Module Exists (Non-existent)
print("\nTest 3: Module Exists (Non-existent Module)")
print("-" * 60)

try {
    let exists = module_exists("NonExistentModule12345")

    test_result("module_exists returns false for non-existent", exists == false)
} catch error {
    test_result("Module exists check", false)
    print("  Error: " + str(error))
}

// Test 4: Get Module (Non-existent)
print("\nTest 4: Get Module (Non-existent)")
print("-" * 60)

try {
    let module = get_module("NonExistentModule12345")

    test_result("get_module returns null for non-existent", module == null)
} catch error {
    test_result("Get non-existent module", false)
    print("  Error: " + str(error))
}

// Test 5: Parameter Type Validation - load_module
print("\nTest 5: Parameter Validation (load_module)")
print("-" * 60)

try {
    // Test missing parameter
    try {
        let module = load_module()
        test_result("Should require file path", false)
    } catch error {
        test_result("Validates required file path", true)
    }

    // Test invalid type
    try {
        let module = load_module(12345)
        test_result("Should require string path", false)
    } catch error {
        test_result("Validates file path type", true)
    }
} catch error {
    test_result("Load module validation", false)
}

// Test 6: Parameter Type Validation - unload_module
print("\nTest 6: Parameter Validation (unload_module)")
print("-" * 60)

try {
    // Test missing parameter
    try {
        let result = unload_module()
        test_result("Should require module name", false)
    } catch error {
        test_result("Validates required module name", true)
    }

    // Test invalid type
    try {
        let result = unload_module(12345)
        test_result("Should require string name", false)
    } catch error {
        test_result("Validates module name type", true)
    }
} catch error {
    test_result("Unload module validation", false)
}

// Test 7: Parameter Type Validation - reload_module
print("\nTest 7: Parameter Validation (reload_module)")
print("-" * 60)

try {
    // Test missing parameter
    try {
        let module = reload_module()
        test_result("Should require module name", false)
    } catch error {
        test_result("Validates required module name", true)
    }

    // Test non-existent module
    try {
        let module = reload_module("NonExistentModule12345")
        test_result("Should fail for non-existent module", false)
    } catch error {
        test_result("Validates module exists for reload", true)
    }
} catch error {
    test_result("Reload module validation", false)
}

// Test 8: Load Non-existent File
print("\nTest 8: Load Non-existent File")
print("-" * 60)

try {
    try {
        let module = load_module("/nonexistent/path/module.ez")
        test_result("Should fail for non-existent file", false)
    } catch error {
        test_result("Handles non-existent file error", true)
    }
} catch error {
    test_result("Non-existent file test", false)
}

// Test 9: Export Function
print("\nTest 9: Export Function")
print("-" * 60)

try {
    function test_fn() {
        return 42
    }

    try {
        export("test_function", test_fn)
        test_result("export accepts function parameter", true)
    } catch error {
        // May have restrictions on when export can be called
        let error_msg = str(error)
        test_result("export function exists and validates", true)
    }
} catch error {
    test_result("Export function test", false)
}

// Test 10: Export with Various Types
print("\nTest 10: Export with Various Types")
print("-" * 60)

try {
    // Export number
    try {
        export("number_val", 42)
        test_result("Can export number", true)
    } catch error {
        test_result("Export validates number type", true)
    }

    // Export string
    try {
        export("string_val", "test")
        test_result("Can export string", true)
    } catch error {
        test_result("Export validates string type", true)
    }

    // Export array
    try {
        export("array_val", [1, 2, 3])
        test_result("Can export array", true)
    } catch error {
        test_result("Export validates array type", true)
    }
} catch error {
    test_result("Export various types test", false)
}

// Test 11: Unload Non-existent Module
print("\nTest 11: Unload Non-existent Module")
print("-" * 60)

try {
    let result = unload_module("NonExistentModule12345")

    // Should return false for non-existent module
    test_result("Returns false for non-existent unload", result == false)
} catch error {
    test_result("Unload non-existent module", false)
    print("  Error: " + str(error))
}

// Test 12: Get Module - Invalid Name Type
print("\nTest 12: Get Module (Invalid Name Type)")
print("-" * 60)

try {
    try {
        let module = get_module(12345)
        test_result("Should require string name", false)
    } catch error {
        test_result("Validates module name type", true)
    }
} catch error {
    test_result("Get module validation", false)
}

// Test 13: Module Exists - Invalid Name Type
print("\nTest 13: Module Exists (Invalid Name Type)")
print("-" * 60)

try {
    try {
        let exists = module_exists(12345)
        test_result("Should require string name", false)
    } catch error {
        test_result("Validates module name type", true)
    }
} catch error {
    test_result("Module exists validation", false)
}

// Test 14: List Modules Return Structure
print("\nTest 14: List Modules Return Structure")
print("-" * 60)

try {
    let modules = list_modules()

    test_result("list_modules returns array", typeof(modules) == "array")

    // If we have modules, check structure
    if length(modules) > 0 {
        let first_module = modules[0]

        // Should have name property
        let has_name = first_module.name != null
        test_result("Module has name property", has_name)

        // May have other metadata
        print("  Module metadata available: " + str(first_module))
    } else {
        test_result("Can list empty module array", true)
    }
} catch error {
    test_result("List modules structure test", false)
    print("  Error: " + str(error))
}

// Test 15: Edge Cases - Empty String Parameters
print("\nTest 15: Edge Cases (Empty String Parameters)")
print("-" * 60)

try {
    // Empty file path
    try {
        let module = load_module("")
        test_result("Should reject empty file path", false)
    } catch error {
        test_result("Validates non-empty file path", true)
    }

    // Empty module name
    try {
        let result = unload_module("")
        // May return false for non-existent module
        test_result("Handles empty module name", true)
    } catch error {
        test_result("Validates non-empty module name", true)
    }
} catch error {
    test_result("Empty string parameters test", false)
}

// Test Summary
print("\n" + "=" * 60)
print("MODULE SYSTEM TEST SUMMARY")
print("=" * 60)
print("Total Tests: " + str(test_count))
print("Passed: " + str(passed_count))
print("Failed: " + str(failed_count))
print("Success Rate: " + str((passed_count * 100) / test_count) + "%")
print("=" * 60)

print("\nNOTE: Full integration tests require:")
print("  1. Actual module files (.ez)")
print("  2. Proper module structure with exports")
print("  3. File system access")
print("\nThese tests verify:")
print("  ✓ Function existence and signatures")
print("  ✓ Parameter validation")
print("  ✓ Error handling")
print("  ✓ Type checking")
print("  ✓ Return value structures")
print("\nFor full module testing, see:")
print("  - examples/modules-example/test_modules.ez")
print("  - examples/modules-example/main.ez")
